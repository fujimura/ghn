#!/usr/bin/env ruby
$LOAD_PATH << File.join(__dir__, '..', 'lib')
require 'ghn'
require 'optparse'

auth_error_message = <<EOM
Authorization required.

Please set ghn.token to your .gitconfig.
    $ git config --global ghn.token [Your GitHub access token]
EOM

access_token = ENV['ACCESS_TOKEN'] || `git config ghn.token`.chomp
if access_token.nil? || access_token.empty?
  puts auth_error_message; exit!
end
ghn = Ghn.new(access_token)

options = Ghn::Options.new(ARGV.getopts(Ghn::Options.short_options, *Ghn::Options.long_options))

if options.open_browser?
  options.mark_as_read = false
end

command = Ghn::Command.new(ARGV)
unless command.valid?
  command.print_invalid
  Ghn::Options.print_usage_exit
end

ghn.send(*ARGV).each do |notification|
  if ghn.open_browser?
    system "open #{notification}"
  else
    puts notification
  end
end
